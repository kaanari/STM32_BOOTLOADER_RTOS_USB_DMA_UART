/*
 * bootloader.c
 *
 *  Created on: Sep 1, 2022
 *      Author: kaanari
 */
#include "bootloader.h"


void bootloader(void)
{

	printf("Bootloader is running...\r\n");

	boot_information_t boot_information = check_applications();



	printf("%X\r\n",boot_information.existance);
	printf("%X\r\n",boot_information.validation);

	uint8_t result = select_application_to_boot(boot_information);

}

uint8_t select_application_to_boot(boot_information_t boot_information);

/* This function is used for checking if applications
 * that resides in each sector of the memory exists */
boot_information_t check_applications()
{
	boot_information_t boot_information;
	uint8_t status = 0;
	uint8_t app_num = 0;
	uint32_t* app_start_address = 0;
	for(; app_num < NUMBER_OF_APP; app_num++)
	{
		app_start_address = BOOTLOADER_ADDRESS + FLASH_SECTOR_SIZE*(app_num+1);
		if(*app_start_address >= APP_ADDRESS_SPACE_LOW && *app_start_address <= APP_ADDRESS_SPACE_MAX){
			printf("APP%d is presented.\r\n", app_num+1);
			status = status ^ (1 << app_num);
		}else{
			printf("APP%d is NOT presented.\r\n", app_num+1);
		}
	}
	boot_information.existance = status;

	/* ToDo: Append CRC check here! */
	boot_information.validation = 0xFF;

	return boot_information;
}
